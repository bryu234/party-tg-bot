# PartyShare

PartyShare — Telegram-бот для дружеских мероприятий с честным делением расходов.

## Возможности

- Создание событий и управление ими только владельцем.
- Приглашения по username и токен-ссылкам.
- Личный кабинет с вкладками «Я владелец» и «Я участник».
- Общие и позиционные расходы, честное распределение и сведение долгов.
- Автоматические напоминания за три дня до начала события.

## Структура проекта

Исходный код находится в директории `src/partyshare`. Тесты — в `tests/`.

## Установка

1. Убедитесь, что установлены Python 3.11+, Docker, docker-compose.
2. Установите зависимости локально (опционально, если хотите запускать без Docker):
   ```bash
   python -m venv .venv
   .venv\Scripts\activate  # Windows
   pip install -e .[dev]
   ```

## ENV-переменные

Скопируйте пример и заполните необходимые значения:

```bash
cp .env.example .env
```

Минимальные значения:
- `BOT_TOKEN` — токен бота Telegram (получается у [@BotFather](https://t.me/BotFather)).
- `DATABASE_URL` — строка подключения к БД (по умолчанию настроена на docker-compose).
- `TZ` — таймзона пользователя (рекомендуется `Europe/Moscow`).

## Быстрый старт в Docker

1. Скопируйте `.env` и заполните токен.
2. Поднимите инфраструктуру:
   ```bash
   make up
   ```
   Команда соберёт образ, поднимет PostgreSQL и бота. Alembic миграции применяются автоматически внутри контейнера.
3. Откройте Telegram и отправьте боту `/start`.
4. Создайте событие `/newevent ...` и проверьте `/myevents`.

## Локальный запуск без Docker

1. Активируйте виртуальное окружение и установите зависимости (см. раздел «Установка»).
2. Запустите PostgreSQL локально и создайте БД `partyshare`.
3. Примените миграции:
   ```bash
   alembic upgrade head
   ```
4. Запустите бота:
   ```bash
   python -m partyshare.bot
   ```

## Работа с миграциями Alembic

- Создать новую миграцию:
  ```bash
  alembic revision -m "описание"
  ```
- Автогенерация на основе моделей БД:
  ```bash
  alembic revision --autogenerate -m "описание"
  ```
- Применить миграции:
  ```bash
  alembic upgrade head
  ```

## Команды Makefile

- `make up` — запустить docker-compose и применить миграции.
- `make mig` — создать новую миграцию и выполнить `alembic upgrade head` (нужна установленная локальная среда).
- `make test` — запустить pytest.
- `make lint` — запустить ruff, black, mypy.

## Тесты

Тесты помогают автоматически проверить, что ключевые части проекта работают как задумано. Они особенно полезны, когда добавляются новые функции — можно быстро убедиться, что ничего не сломалось.

В проекте есть несколько наборов тестов:
- Расчёт долей и балансов (`tests/test_split.py`, `tests/test_settlement.py`).
- Проверка авторизационных правил (`tests/test_authz.py`).
- Проверка приглашений и токенов (`tests/test_invitelink.py`).
- Форматирование карточек событий (`tests/test_myevents.py`).

Запустить их можно командой:
```bash
pytest
```
или через Makefile:
```bash
make test
```

При запуске вы увидите вывод о прохождении/провале тестов. Если тест падает, вывод подскажет, где искать ошибку.

## Полезные команды Telegram-бота

- `/start` — приветствие и базовая помощь.
- `/newevent` — создать событие.
- `/myevents` — личный кабинет с вкладками.
- `/manage <event_id>` — открывает меню управления событием.
- `/invitelink` и `/invite` — различные способы приглашений.
- `/join <token>` — присоединиться по токену.
- `/addexpense`, `/additem` — добавление расходов и позиций.
- `/summary`, `/settle` — расчёт долей и сведений долгов.
- `/transfer_ownership`, `/remove` — управление участниками и владельцем.

Внутри `/myevents` доступны inline-кнопки для быстрого переключения вкладок, просмотра сводки, изменения статуса, открытия меню управления и т.д.

